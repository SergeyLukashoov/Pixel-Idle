name: unity-build-and-ios-upload

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Select build type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - short

jobs:
  buildForAllSupportedPlatforms:
    name: Build for ${{ matrix.targetPlatform }} on ${{ matrix.unity-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        unity-version:
          - ${{ vars.UNITY_VERSION || '2022.3.62f3' }}
        os:
          - ubuntu-latest
        targetPlatform:
          - iOS
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1

      - name: Cache Library folder
        uses: actions/cache@v3
        with:
          path: Library
          key: Library-${{ matrix.targetPlatform }}
          restore-keys: Library-
      
      - name: Cache Unity packages
        uses: game-ci/unity-builder@v4.8.1
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          targetPlatform: ${{ matrix.targetPlatform }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-${{ matrix.targetPlatform }}
          path: build/${{ matrix.targetPlatform }}


  xcodeBuildAndUpload:
    name: Xcode Build and Upload to TestFlight on ${{ matrix.unity-version }}
    needs: buildForAllSupportedPlatforms
    runs-on: macos-latest
    env:
      IOS_BUILD_PATH: ${{ format('{0}/build/iOS', github.workspace) }}
    strategy:
      fail-fast: false
      matrix:
        unity-version:
          - ${{ vars.UNITY_VERSION || '6000.2.8f1' }}
        targetPlatform:
          - iOS
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download iOS Artifact
        uses: actions/download-artifact@v4
        with:
          name: Build-${{ matrix.targetPlatform }}
          path: build/${{ matrix.targetPlatform }}

      - name: Ensure required iPad app icons exist
        run: |
          set -euo pipefail
          APPICON_DIR="build/iOS/iOS/Images.xcassets/AppIcon.appiconset"
          CONTENTS_JSON="$APPICON_DIR/Contents.json"

          if [ ! -d "$APPICON_DIR" ] || [ ! -f "$CONTENTS_JSON" ]; then
            echo "AppIcon asset catalog not found, skipping icon patch."
            exit 0
          fi

          SRC_ICON=""
          for candidate in \
            "$APPICON_DIR"/*1024*.png \
            "$APPICON_DIR"/*512*.png \
            "$APPICON_DIR"/*180*.png \
            "$APPICON_DIR"/*120*.png \
            "$APPICON_DIR"/*.png; do
            if [ -f "$candidate" ]; then
              SRC_ICON="$candidate"
              break
            fi
          done

          if [ -z "$SRC_ICON" ]; then
            echo "No source icon png found in $APPICON_DIR"
            exit 1
          fi

          echo "Using source icon: $SRC_ICON"
          sips -z 152 152 "$SRC_ICON" --out "$APPICON_DIR/Icon-App-76x76@2x.png" >/dev/null
          sips -z 167 167 "$SRC_ICON" --out "$APPICON_DIR/Icon-App-83.5x83.5@2x.png" >/dev/null

          python3 - <<'PY'
          import json
          from pathlib import Path

          contents_path = Path("build/iOS/iOS/Images.xcassets/AppIcon.appiconset/Contents.json")
          data = json.loads(contents_path.read_text(encoding="utf-8"))
          images = data.get("images", [])

          required = [
            {"idiom": "ipad", "size": "76x76", "scale": "2x", "filename": "Icon-App-76x76@2x.png"},
            {"idiom": "ipad", "size": "83.5x83.5", "scale": "2x", "filename": "Icon-App-83.5x83.5@2x.png"},
          ]

          for req in required:
            found = None
            for img in images:
              if img.get("idiom") == req["idiom"] and img.get("size") == req["size"] and img.get("scale") == req["scale"]:
                found = img
                break
            if found is None:
              images.append(req)
            else:
              found["filename"] = req["filename"]

          data["images"] = images
          contents_path.write_text(json.dumps(data, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          PY

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: "16.4"

      - name: Verify selected Xcode
        run: |
          xcodebuild -version
          xcode-select -p

      - name: Setup xcode versioning system
        run: |
          ruby <<'RUBY'
          require 'xcodeproj'
          project = Xcodeproj::Project.open('build/iOS/iOS/Unity-iPhone.xcodeproj')
          project.targets.each do |target|
            target.build_configurations.each do |config|              
              config.build_settings['VERSIONING_SYSTEM'] = 'apple-generic'
              config.build_settings['CURRENT_PROJECT_VERSION'] = ENV['LAST_UPLOADED_BUILD_NUMBER'] || '0'
              if ['Unity-iPhone', 'notifications'].include?(target.name)
                config.build_settings['TARGETED_DEVICE_FAMILY'] = '1,2'
              end
              puts "#{target.name} - #{config.build_settings['VERSIONING_SYSTEM']}"
            end
          end
          project.save
          RUBY

      - name: Install agvtool
        run: |
          sudo xcodebuild -license accept
          which agvtool || echo 'agvtool not found, but should be available with Xcode.'
          agvtool help || echo 'agvtool installed.'
        
      - name: Set up ruby env
        uses: ruby/setup-ruby@v1.269.0
        with:
          ruby-version: 3.3
          bundler-cache: true

      - name: Generate MATCH_GIT_BASIC_AUTHORIZATION
        run: |
          echo -n "NikDyr:${GH_PAT}" | base64 > base64.txt
          echo "MATCH_GIT_BASIC_AUTHORIZATION=$(cat base64.txt)" >> $GITHUB_ENV
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          
      - name: Build & upload iOS binary
        run: |
          if [ "${{ github.event.inputs.build_type }}" = "short" ]; then
            bundle exec fastlane ios short_build_upload_testflight
          else
            bundle exec fastlane ios full_build_upload_testflight
          fi
        env:
          FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT: "30"
          FASTLANE_XCODEBUILD_SETTINGS_RETRIES: "6"
          ASC_KEY_ID: ${{ secrets.APPSTORE_KEY_ID }}
          ASC_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          ASC_KEY: ${{ secrets.APPSTORE_P8 }}
          MATCH_GIT_BASIC_AUTHORIZATION: ${{ env.MATCH_GIT_BASIC_AUTHORIZATION }}
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          TEAM_ID: ${{ vars.APPLE_TEAM_ID || secrets.APPLE_TEAM_ID }}
          BUNDLE_IDENTIFIER: ${{ vars.BUNDLE_IDENTIFIER || secrets.BUNDLE_IDENTIFIER }}
          MATCH_GIT_URL: ${{ vars.MATCH_GIT_URL || secrets.MATCH_GIT_URL }}
          APPLE_ID_DIGITS: ${{ vars.APPLE_ID_DIGITS || secrets.APPLE_ID_DIGITS }}
          XC_TARGET_NAME: "Unity-iPhone"
          IOS_BUILD_PATH: ${{ format('{0}/build/iOS', github.workspace) }}
          BUILD_TYPE: ${{ github.event.inputs.build_type }}
          LAST_UPLOADED_BUILD_NUMBER: ${{ vars.LAST_UPLOADED_BUILD_NUMBER || secrets.LAST_UPLOADED_BUILD_NUMBER }}
          MAJOR_VERSION: ${{ vars.MAJOR_VERSION || secrets.MAJOR_VERSION }}